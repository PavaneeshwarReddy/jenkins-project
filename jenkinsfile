

pipeline {
    agent any

    environment {
        SLACK_CHANNEL = "#jenkins"
        STAGE_ERROR_MESSAGE = ""
    }

    stages {
        stage("Checkout to Git Repository") {
            steps {
                script {
                    sendSlackMessage("${BUILD_ID}: Build Started ${BUILD_NUMBER}", 'SUCCESS')
                    checkout([$class: 'GitSCM', branches: [[name: '*/main']],
                        userRemoteConfigs: [[url: 'https://github.com/PavaneeshwarReddy/jenkins-project.git']]
                    ])
                }
            }
        }
        stage("Build") {
            agent {
                docker {
                    image 'node:22-alpine3.19'
                    reuseNode true
                    args '-u root'
                }
            }
            steps {
                script {
                    sendSlackMessage("Build stage started for ${BUILD_NUMBER}",'SUCCESS')
                    echo 'npm --version'
                    try {
                        sh 'npm install'
                        dir('./dockerchecks') {
                            sh 'node nodetest.js'
                        }
                    } catch(Exception e) {
                        currentBuild.result = 'FAILURE'
                        env.STAGE_ERROR_MESSAGE = "Build stage failed: ${e.message}"
                        sh 'exit 1'
                    }
                    echo 'Build Stage successful'
                    sendSlackMessage("Build stage successful, proceeding to next stage", 'SUCCESS')
                }
            }
        }
        stage("Test") {
            steps {
                sh 'npm install --save-dev jest'
                sh 'npm test'
            }
        }
        stage("Package") {
            agent {
                docker {
                    image 'docker:27.0.1-cli'
                    reuseNode true
                }
            }
            steps {
                echo "This is Package stage"
                echo "docker --version"
            }
        }
        stage("Deploy") {
            steps {
                echo "This is a Deploy stage"
            }
        }
    }

    post {
        always {
            echo 'Pipeline completed.'
            sendSlackMessage("Pipeline completed",currentBuild.result)
        }
        success {
            echo 'Pipeline completed successfully!'
        }
        failure {
            echo 'Pipeline failed.'
            sendSlackMessage(env.STAGE_ERROR_MESSAGE ?: "Pipeline failed without specific error message",'FAILURE')
        }
    }
}

//function to return the color code
String colorCode(String type) {
    def COLOR_MAPPING = [
        SUCCESS: '#00FF00',
        FAILURE: '#FF0000',
        ABORTED: '#FFFF00',
        UNSTABLE: '#FFA500'
    ]
    return COLOR_MAPPING[type]
}

// Function to send Slack message
void sendSlackMessage(String message, String type) {
    slackSend(
        color: colorCode(type),
        message: message,
        channel: env.SLACK_CHANNEL,
    )
}
